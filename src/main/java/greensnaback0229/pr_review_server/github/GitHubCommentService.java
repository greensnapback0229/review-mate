package greensnaback0229.pr_review_server.github;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.kohsuke.github.GHIssueComment;
import org.kohsuke.github.GHPullRequest;
import org.kohsuke.github.GHRepository;
import org.kohsuke.github.GitHub;
import org.springframework.stereotype.Service;

import java.io.IOException;

/**
 * GitHub PRì— ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ì„œë¹„ìŠ¤
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class GitHubCommentService {
    
    private final GitHub github;
    
    /**
     * PRì— ë¦¬ë·° ê²°ê³¼ë¥¼ ì½”ë©˜íŠ¸ë¡œ ì‘ì„±
     *
     * @param repoFullName ì €ì¥ì†Œ í’€ë„¤ì„ (ì˜ˆ: owner/repo)
     * @param prNumber PR ë²ˆí˜¸
     * @param reviewContent ë¦¬ë·° ë‚´ìš©
     * @throws IOException GitHub API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ
     */
    public void postReviewComment(String repoFullName, int prNumber, String reviewContent) throws IOException {
        log.info("Posting review comment to {}/#{}", repoFullName, prNumber);
        
        try {
            GHRepository repository = github.getRepository(repoFullName);
            GHPullRequest pullRequest = repository.getPullRequest(prNumber);
            
            // ì½”ë©˜íŠ¸ ì‘ì„±
            String comment = formatReviewComment(reviewContent);
            GHIssueComment postedComment = pullRequest.comment(comment);
            
            log.info("Successfully posted comment #{} to {}/#{}", 
                    postedComment.getId(), repoFullName, prNumber);
            
        } catch (IOException e) {
            log.error("Failed to post comment to {}/{}: {}", 
                    repoFullName, prNumber, e.getMessage(), e);
            throw e;
        }
    }
    
    /**
     * ë¦¬ë·° ë‚´ìš©ì„ GitHub ì½”ë©˜íŠ¸ í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
     *
     * @param reviewContent ì›ë³¸ ë¦¬ë·° ë‚´ìš©
     * @return í¬ë§·íŒ…ëœ ì½”ë©˜íŠ¸
     */
    private String formatReviewComment(String reviewContent) {
        StringBuilder sb = new StringBuilder();
        
        sb.append("## ğŸ¤– AI Code Review\n\n");
        sb.append(reviewContent);
        sb.append("\n\n---\n");
        sb.append("*Generated by PR Review Mate*");
        
        return sb.toString();
    }
}
